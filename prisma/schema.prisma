generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String   @id @default(cuid())
  githubId       Int      @unique
  username       String   @unique
  email          String?
  avatarUrl      String?
  installationId Int?     @unique
  accessToken    String?
  refreshToken   String?
  tokenExpiresAt DateTime?
  isAdmin        Boolean  @default(false)
  isBanned       Boolean  @default(false)
  bannedAt       DateTime?
  bannedReason   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  lastLoginAt    DateTime @default(now())

  repoOrder RepoOrder?
  syncLogs  SyncLog[]
  orderSnapshots OrderSnapshot[]

  @@map("users")
}

model RepoOrder {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Orden de repos: JSON string de array de repo full names
  reposOrder    String   @default("[]")

  // Cuantos repos ordenar (0 = todos)
  topN          Int      @default(10)

  // Incluir repos privados en el ordenamiento
  includePrivate Boolean @default(true)

  // Configuracion de sync
  syncFrequency Int      @default(168)
  autoEnabled   Boolean  @default(true)

  // Estrategia de commits: "branch" o "revert"
  commitStrategy String  @default("revert")

  // Programación horaria avanzada
  preferredHour  Int?    // Hora preferida del día (0-23), null = cualquier hora
  preferredDays  String  @default("[]") // JSON array de días: [0,1,2,3,4,5,6] donde 0=Dom, 1=Lun...

  // Secret para el endpoint de sync (UUID)
  syncSecret String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("repo_orders")
}

model SyncLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  action    String
  status    String
  details   String?
  reposAffected String @default("[]")

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@map("sync_logs")
}

model OrderSnapshot {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Orden de repos: JSON string de array de repo full names
  reposOrder String

  // Número de repos en el top
  topN       Int

  // Tipo de cambio: "manual" o "auto"
  changeType String   @default("manual")

  createdAt  DateTime @default(now())

  @@index([userId, createdAt])
  @@map("order_snapshots")
}
